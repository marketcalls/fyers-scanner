{% extends "base.html" %}

{% block title %}Scan Results - {{ watchlist.name }}{% endblock %}

{% block content %}
<div class="container" style="padding-top: 2rem; padding-bottom: 4rem;">
    <div style="margin-bottom: 2rem;">
        <a href="/scan/{{ watchlist.id }}" class="text-secondary" style="font-size: 0.875rem; text-decoration: none;">← Back to Scan</a>
        <h1 style="font-size: 2.5rem; font-weight: 700; margin-top: 0.5rem; margin-bottom: 0.5rem;">
            Scan Results: <span class="text-accent">{{ watchlist.name }}</span>
        </h1>
        <p class="text-secondary">Timeframe: {{ timeframe }}m | {{ scan_time.strftime('%Y-%m-%d %H:%M:%S') }}</p>
    </div>

    <!-- Summary Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total Symbols</div>
            <div class="stat-value">{{ results|length }}</div>
            <div class="stat-desc">Scanned successfully</div>
        </div>

        <div class="stat-card" style="border-color: var(--success-green);">
            <div class="stat-label">Buy Signals</div>
            <div class="stat-value" style="color: var(--success-green);">{{ buy_signals }}</div>
            <div class="stat-desc">Bullish crossovers</div>
        </div>

        <div class="stat-card" style="border-color: var(--error-red);">
            <div class="stat-label">Sell Signals</div>
            <div class="stat-value" style="color: var(--error-red);">{{ sell_signals }}</div>
            <div class="stat-desc">Bearish crossovers</div>
        </div>

        <div class="stat-card">
            <div class="stat-label">Neutral</div>
            <div class="stat-value" style="color: var(--text-secondary);">{{ neutral_signals }}</div>
            <div class="stat-desc">No crossover</div>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
        <button onclick="filterResults('all')" class="filter-btn btn btn-secondary active-filter" data-filter="all">
            All ({{ results|length }})
        </button>
        <button onclick="filterResults('buy')" class="filter-btn btn btn-secondary" data-filter="buy" style="border-color: var(--success-green); color: var(--success-green);">
            Buy ({{ buy_signals }})
        </button>
        <button onclick="filterResults('sell')" class="filter-btn btn btn-secondary" data-filter="sell" style="border-color: var(--error-red); color: var(--error-red);">
            Sell ({{ sell_signals }})
        </button>
        <button onclick="filterResults('neutral')" class="filter-btn btn btn-secondary" data-filter="neutral">
            Neutral ({{ neutral_signals }})
        </button>
    </div>

    <!-- Results Table -->
    {% if results %}
    <div class="card">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Symbol</th>
                        <th>Display Name</th>
                        <th>Signal</th>
                        <th>Current Price</th>
                        <th>10 EMA</th>
                        <th>20 EMA</th>
                        <th>Timeframe</th>
                    </tr>
                </thead>
                <tbody id="resultsTable">
                    {% for result in results %}
                    <tr class="result-row" data-signal="{{ result.signal.lower() }}">
                        <td>{{ loop.index }}</td>
                        <td><code style="font-size: 0.875rem;">{{ result.symbol }}</code></td>
                        <td style="font-weight: 600;">{{ result.display_name }}</td>
                        <td>
                            {% if result.signal == 'BUY' %}
                            <span class="badge badge-success">
                                ↗ BUY
                            </span>
                            {% elif result.signal == 'SELL' %}
                            <span class="badge badge-error">
                                ↘ SELL
                            </span>
                            {% else %}
                            <span class="badge badge-neutral">─ NEUTRAL</span>
                            {% endif %}
                        </td>
                        <td style="font-family: monospace;">₹{{ result.current_price }}</td>
                        <td style="font-family: monospace; font-size: 0.875rem; color: var(--text-secondary);">₹{{ result.ema10 }}</td>
                        <td style="font-family: monospace; font-size: 0.875rem; color: var(--text-secondary);">₹{{ result.ema20 }}</td>
                        <td class="text-secondary" style="font-size: 0.875rem;">{{ result.timeframe }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="alert alert-warning">
        <div>
            <strong>⚠</strong>
            <span>No results available. There may have been errors fetching data for some symbols.</span>
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="flex gap-4" style="margin-top: 2rem; flex-wrap: wrap;">
        <a href="/scan/{{ watchlist.id }}" class="btn btn-primary">Run New Scan</a>
        <a href="/watchlist/{{ watchlist.id }}" class="btn btn-secondary">Manage Watchlist</a>
        <a href="/dashboard" class="btn btn-ghost">Back to Dashboard</a>
    </div>
</div>

<style>
.active-filter {
    background-color: rgba(62, 207, 142, 0.2);
    border-color: var(--accent-green);
    color: var(--accent-green);
}
</style>

<script>
function filterResults(signal) {
    const rows = document.querySelectorAll('.result-row');
    const buttons = document.querySelectorAll('.filter-btn');

    // Update active button
    buttons.forEach(btn => {
        if (btn.dataset.filter === signal) {
            btn.classList.add('active-filter');
        } else {
            btn.classList.remove('active-filter');
        }
    });

    // Filter rows
    rows.forEach(row => {
        if (signal === 'all') {
            row.style.display = '';
        } else if (row.dataset.signal === signal) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}
</script>
{% endblock %}
